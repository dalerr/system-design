# CAP-теорема

## Определение

**CAP-теорема** (также известная как **теорема Брюера**) утверждает, что в распределенной системе при сетевом разделении (network partition) можно гарантировать только **2 из 3** свойств:

- **C (Consistency)** — консистентность
- **A (Availability)** — доступность
- **P (Partition tolerance)** — устойчивость к разделению сети

---

## Три свойства CAP

### 1. Consistency (Консистентность)

**Определение:**
Все узлы распределенной системы видят **одинаковые данные одновременно**.

**Также называется:**
- Strong consistency
- Линейная консистентность (linearizability)

**Характеристики:**
- После записи все узлы сразу видят новое значение
- Нет возможности прочитать устаревшие данные
- Все операции упорядочены во времени

**Пример:**
```
Узел A записывает X = 100
→ Все узлы (A, B, C) сразу видят X = 100
→ Невозможно прочитать старое значение
```

**Когда важна:**
- Банковские балансы
- Финансовые транзакции
- Резервирование товаров
- Критичные операции

---

### 2. Availability (Доступность)

**Определение:**
Система **отвечает на запросы** даже при сбоях компонентов.

**Характеристики:**
- Система продолжает работать при частичных сбоях
- Каждый запрос получает ответ (не ошибку)
- Нет downtime

**Пример:**
```
Узел A недоступен
→ Система продолжает работать через узлы B и C
→ Все запросы получают ответы
→ Нет ошибок "service unavailable"
```

**Когда важна:**
- Высоконагруженные системы
- Публичные API
- E-commerce платформы
- Социальные сети

---

### 3. Partition Tolerance (Устойчивость к разделению сети)

**Определение:**
Система **продолжает работать** при разделении сети (network partition).

**Network Partition:**
Разделение сети на части, которые не могут общаться друг с другом.

**Пример:**
```
Изначально: Узел A ←→ Узел B ←→ Узел C

После partition:
  Группа 1: Узел A
  Группа 2: Узел B ←→ Узел C
  
Группы не могут общаться друг с другом
```

**Характеристики:**
- Система работает даже при разрыве связи между узлами
- Узлы в разных группах не могут синхронизироваться
- Это неизбежно в распределенных системах

**Когда важна:**
- Все распределенные системы
- Географически распределенные системы
- Облачные системы

---

## Формулировка теоремы

**CAP-теорема утверждает:**

> В распределенной системе при сетевом разделении (partition) можно гарантировать только **2 из 3** свойств: Consistency, Availability, Partition Tolerance.

**Важно понимать:**
- Это не означает, что система не может иметь все 3 свойства
- Это означает, что **при partition** нужно выбрать 2 из 3
- В нормальных условиях (без partition) система может иметь все 3 свойства

---

## Три комбинации CAP

### 1. CP системы (Consistency + Partition Tolerance)

**Характеристики:**
- ✅ Гарантирует консистентность данных
- ✅ Работает при разделении сети
- ❌ Жертвует доступностью (может быть недоступна при partition)

**Поведение при partition:**
- Система блокирует запросы на запись
- Система может блокировать запросы на чтение
- Возвращает ошибки вместо устаревших данных

**Пример сценария:**
```
Partition произошел:
  Группа 1: Узел A (имеет X = 100)
  Группа 2: Узел B (имеет X = 100)

Пользователь пытается прочитать X:
  → Система не может гарантировать актуальность данных
  → Система возвращает ошибку (недоступна)
  → Лучше недоступность, чем неконсистентные данные
```

**Примеры систем:**
- **Spanner** (Google) — глобально распределенная БД с strong consistency
- **MongoDB** (с strong consistency mode)
- **HBase** — NoSQL БД с strong consistency
- **PostgreSQL** (в распределенной конфигурации)
- **Redis** (с strong consistency)

**Когда использовать:**
- Банковские системы
- Финансовые транзакции
- Критичные операции, где точность важнее доступности
- Системы, где неконсистентные данные недопустимы

---

### 2. AP системы (Availability + Partition Tolerance)

**Характеристики:**
- ✅ Гарантирует доступность
- ✅ Работает при разделении сети
- ❌ Жертвует консистентностью (возможны временные расхождения)

**Поведение при partition:**
- Система продолжает отвечать на запросы
- Разные узлы могут показывать разные данные
- В конечном итоге данные синхронизируются (eventual consistency)

**Пример сценария:**
```
Partition произошел:
  Группа 1: Узел A (имеет X = 100)
  Группа 2: Узел B (имеет X = 100)

Пользователь в группе 1 записывает X = 200:
  → Узел A обновляет X = 200
  → Узел B не знает об обновлении (partition)

Пользователь в группе 2 читает X:
  → Узел B возвращает X = 100 (устаревшее значение)
  → Система доступна, но данные неконсистентны
  → После восстановления связи данные синхронизируются
```

**Примеры систем:**
- **Cassandra** — NoSQL БД с eventual consistency
- **DynamoDB** (по умолчанию) — AWS NoSQL БД
- **CouchDB** — документная БД
- **Riak** — распределенная key-value БД
- **Voldemort** — распределенное хранилище

**Когда использовать:**
- Социальные сети (лайки, комментарии)
- E-commerce каталоги
- Системы, где доступность важнее точности
- Системы, где допустимы временные расхождения

---

### 3. CA системы (Consistency + Availability)

**Характеристики:**
- ✅ Гарантирует консистентность данных
- ✅ Гарантирует доступность
- ❌ Не устойчива к разделению сети (не распределенная)

**Поведение при partition:**
- Система не может работать при partition
- Требует единую сеть без разделений
- По сути, это не распределенная система

**Примеры систем:**
- **PostgreSQL** (в одной зоне, без репликации)
- **MySQL** (в одной зоне, без репликации)
- **SQLite** — локальная БД
- Традиционные SQL БД в одной зоне доступности

**Когда использовать:**
- Небольшие системы
- Системы в одной зоне доступности
- Системы, где partition маловероятен
- Прототипы и MVP

**Важно:**
В реальных распределенных системах **P нельзя избежать**, поэтому CA системы на практике не существуют в чистом виде для распределенных систем. Они работают только в одной зоне без разделений.

---

## Визуализация CAP

```
        Consistency
            |
            |
    CP -----+----- CA
     |              |
     |              |
     |    CAP       |
     |              |
    AP -----+----- (не существует)
            |
            |
      Availability
```

**Примечание:** CA системы не существуют в распределенных системах, так как P неизбежен.

---

## Реальные примеры

### CP системы

**Google Spanner:**
- Глобально распределенная БД
- Strong consistency между регионами
- При partition может быть недоступна для записи
- Используется для критичных финансовых данных

**MongoDB (с strong consistency):**
- Read concern "majority"
- Write concern "majority"
- При partition блокирует операции
- Используется для критичных данных

---

### AP системы

**Amazon DynamoDB:**
- Высокая доступность
- Eventual consistency по умолчанию
- При partition продолжает работать
- Разные узлы могут показывать разные данные
- Используется для высоконагруженных систем

**Apache Cassandra:**
- Высокая доступность
- Eventual consistency
- При partition продолжает работать
- Используется для больших объемов данных

---

## Важные уточнения

### 1. CAP — это не выбор навсегда

**Миф:** Система должна быть либо CP, либо AP.

**Реальность:**
- Разные части системы могут иметь разные CAP характеристики
- Можно настроить систему для разных use cases
- Можно переключаться между режимами

**Пример:**
```
Система может быть:
  - CP для критичных операций (платежи)
  - AP для некритичных операций (лайки)
```

---

### 2. Partition — это не только сетевые проблемы

**Partition может быть вызван:**
- Сетевыми разрывами
- Медленными сетевыми соединениями
- Перегрузкой сети
- Проблемами с инфраструктурой

**Важно:**
Partition — это норма в распределенных системах, а не исключение.

---

### 3. CAP не означает "все или ничего"

**Системы могут иметь:**
- Разные уровни консистентности (strong, eventual, weak)
- Разные уровни доступности (99%, 99.9%, 99.99%)
- Разные стратегии обработки partition

**Пример:**
```
Система может быть:
  - 99.9% доступной (не 100%)
  - Eventual consistency (не strong, не weak)
  - Устойчивой к partition
```

---

## PACELC-теорема (расширение CAP)

**PACELC** расширяет CAP-теорему:

> При **Partition** (P) выбираем между **Availability** (A) и **Consistency** (C)
> 
> Иначе (E - Else), выбираем между **Latency** (L) и **Consistency** (C)

**Формулировка:**
- **PAC** — при partition выбираем между A и C
- **ELC** — в нормальных условиях выбираем между L (latency) и C (consistency)

**Примеры:**
- **PACELC = PA/EL** — при partition доступность, в нормальных условиях низкая latency
- **PACELC = PC/EC** — при partition консистентность, в нормальных условиях консистентность

---

## Как выбрать CP vs AP?

### Выбирайте CP когда:
- ✅ Критична точность данных (финансы, балансы)
- ✅ Недопустимы расхождения данных
- ✅ Можно пожертвовать доступностью ради точности
- ✅ Операции должны быть атомарными

**Примеры:**
- Банковские переводы
- Резервирование товаров
- Финансовые транзакции
- Системы голосования

---

### Выбирайте AP когда:
- ✅ Критична доступность (высокая нагрузка)
- ✅ Допустимы временные расхождения
- ✅ Можно пожертвовать точностью ради доступности
- ✅ Операции не критичны для точности

**Примеры:**
- Лайки в соцсетях
- Счетчики просмотров
- Каталог товаров
- Комментарии в блогах

---

## Резюме

**Ключевые моменты:**

1. ✅ **CAP-теорема** — при partition можно гарантировать только 2 из 3 свойств
2. ✅ **P нельзя избежать** в распределенных системах
3. ✅ **CP системы** — консистентность важнее доступности
4. ✅ **AP системы** — доступность важнее консистентности
5. ✅ **CA системы** — не существуют в распределенных системах
6. ✅ **Выбор зависит от требований** — нет универсального решения

**Помните:**
- CAP-теорема — это не ограничение, а понимание компромиссов
- Разные части системы могут иметь разные CAP характеристики
- Правильный выбор зависит от конкретных требований и use cases

**Правило:**
Используйте **CP** для критичных операций, где точность важнее доступности.
Используйте **AP** для высоконагруженных систем, где доступность важнее точности.

