# Консистентность в распределенных системах

## Определение

**Consistency (консистентность)** — это гарантия того, что все узлы распределенной системы видят одинаковые данные в определенный момент времени или в течение определенного периода.

## Типы консистентности

### 1. Strong Consistency (сильная консистентность)

**Определение:**
- Все узлы/реплики видят одинаковые данные **одновременно**
- После записи любое чтение сразу видит новое значение
- Гарантирует: если записали X=100, то следующее чтение всегда вернет X=100

**Характеристики:**
- Линейная консистентность (linearizability)
- Все операции упорядочены во времени
- Нет возможности прочитать устаревшие данные после записи

**Примеры использования:**
- Банковские балансы
- Финансовые транзакции
- Резервирование товаров (inventory)
- Системы голосования
- Критичные финансовые операции

**Технологии:**
- PostgreSQL (с транзакциями)
- Spanner (Google)
- MongoDB (с read concern "majority")
- HBase
- Strong consistency режим в DynamoDB

**Trade-offs (компромиссы):**
- ✅ Гарантированная актуальность данных
- ✅ Нет race conditions
- ❌ Выше latency (нужно ждать синхронизации всех реплик)
- ❌ Ниже availability при сетевых разделах (partition)
- ❌ Меньше throughput (пропускной способности)

**Аналогия:**
Как банковский счет — после перевода все видят обновленный баланс сразу. Невозможно потратить одни и те же деньги дважды.

**Пример:**
```
Пользователь A переводит $100 пользователю B
→ Оба сразу видят обновленные балансы
→ Невозможно потратить деньги дважды
→ Гарантируется атомарность операции
```

---

### 2. Eventual Consistency (консистентность в конечном итоге)

**Определение:**
- Все узлы **в конечном итоге** придут к одинаковому состоянию
- После записи может пройти время, прежде чем все узлы увидят новое значение
- Гарантирует: если записали X=100, то через некоторое время (секунды/минуты) все узлы увидят X=100

**Характеристики:**
- Слабая консистентность с гарантией сходимости
- Возможны временные расхождения между узлами
- В конечном итоге все узлы синхронизируются

**Примеры использования:**
- Лайки в соцсетях
- Счетчики просмотров
- Каталог товаров (e-commerce)
- DNS (Domain Name System)
- Профили пользователей
- Комментарии в блогах

**Технологии:**
- Cassandra
- DynamoDB (по умолчанию)
- CouchDB
- Redis (с репликацией)
- Riak

**Trade-offs (компромиссы):**
- ✅ Выше availability (система работает даже при разделении сети)
- ✅ Выше throughput (не нужно ждать всех реплик)
- ✅ Ниже latency чтения (читаем из ближайшей реплики)
- ❌ Возможны временные расхождения (stale reads)
- ❌ Нужна обработка конфликтов (conflict resolution)

**Аналогия:**
Как лайки в Instagram — твой лайк может появиться у других пользователей с небольшой задержкой. Это не критично, так как точность не важна в реальном времени.

**Пример:**
```
Пользователь A ставит лайк посту
→ Другие пользователи увидят лайк через несколько секунд
→ Не критично, если задержка
→ Система продолжает работать даже при сбоях
```

---

### 3. Weak Consistency (слабая консистентность)

**Определение:**
- Нет гарантий, когда (и если) все узлы увидят одинаковые данные
- После записи разные узлы могут показывать разные значения неопределенное время
- Нет гарантии синхронизации

**Характеристики:**
- Минимальные гарантии консистентности
- Максимальная производительность
- Данные могут быть устаревшими

**Примеры использования:**
- Кеши (CDN)
- Аналитика и метрики
- Временные данные
- Статический контент
- Логи и события

**Технологии:**
- Memcached
- CDN кеши (CloudFlare, AWS CloudFront)
- Локальные кеши приложений
- In-memory хранилища

**Trade-offs (компромиссы):**
- ✅ Максимальная производительность
- ✅ Максимальная availability
- ✅ Минимальная latency
- ❌ Возможны устаревшие данные
- ❌ Нет гарантий синхронизации
- ❌ Не подходит для критичных операций

**Аналогия:**
Как кеш веб-страницы — может показывать старую версию, пока не обновится. Это нормально для статического контента.

**Пример:**
```
Пользователь A смотрит счетчик просмотров видео
→ Может видеть устаревшее значение
→ Не критично для точности
→ Важнее скорость отображения
```

---

## Сравнительная таблица

| Характеристика | Strong | Eventual | Weak |
|----------------|-------|----------|------|
| **Гарантия актуальности** | ✅ Мгновенная | ⚠️ В конечном итоге | ❌ Нет гарантий |
| **Latency чтения** | Высокая | Средняя | Низкая |
| **Throughput** | Низкий | Высокий | Очень высокий |
| **Availability** | Ниже | Выше | Максимальная |
| **Сложность реализации** | Высокая | Средняя | Низкая |
| **Подходит для** | Финансы, критичные данные | Соцсети, каталоги | Кеши, аналитика |

---

## Когда что использовать?

### Strong Consistency — используйте когда:
- ✅ Критична точность данных (финансы, балансы)
- ✅ Невозможны race conditions (резервирование товаров)
- ✅ Нужна атомарность операций
- ✅ Можно пожертвовать производительностью ради точности

### Eventual Consistency — используйте когда:
- ✅ Не критична точность в реальном времени (лайки, просмотры)
- ✅ Нужна высокая доступность
- ✅ Большая нагрузка на чтение
- ✅ Можно принять временные расхождения

### Weak Consistency — используйте когда:
- ✅ Данные не критичны (кеши, метрики)
- ✅ Нужна максимальная производительность
- ✅ Допустимы устаревшие данные
- ✅ Статический или редко меняющийся контент

---

## Связь с CAP-теоремой

**CAP-теорема** утверждает, что в распределенной системе можно гарантировать только 2 из 3 свойств:

- **C (Consistency)** — консистентность
- **A (Availability)** — доступность
- **P (Partition tolerance)** — устойчивость к разделению сети

**Соответствие типов консистентности:**

- **Strong Consistency** → **CP системы** (Consistency + Partition tolerance)
  - Примеры: Spanner, MongoDB (strong mode), HBase
  
- **Eventual Consistency** → **AP системы** (Availability + Partition tolerance)
  - Примеры: Cassandra, DynamoDB, CouchDB

- **Weak Consistency** → **AP системы** (максимальная доступность)
  - Примеры: кеши, CDN

---

## Практические примеры из реальных систем

### Банковская система (Strong)
```
Операция: Перевод $1000 со счета A на счет B
→ Оба баланса обновляются атомарно
→ Невозможно прочитать промежуточное состояние
→ Если операция успешна, оба счета сразу видят изменения
```

### Социальная сеть (Eventual)
```
Операция: Пользователь ставит лайк посту
→ Лайк записывается в ближайшую реплику
→ Другие пользователи увидят лайк через несколько секунд
→ Если один узел недоступен, система продолжает работать
```

### CDN кеш (Weak)
```
Операция: Обновление статьи на сайте
→ Статья обновляется в основной БД
→ CDN кеш может показывать старую версию до TTL
→ Пользователи могут видеть разные версии в зависимости от региона
```

---

## Резюме

Выбор типа консистентности — это **компромисс** между:
- **Точностью данных** (strong)
- **Производительностью** (weak)
- **Доступностью** (eventual/weak)

**Правило:** Используйте самый слабый тип консистентности, который допустим для вашей задачи. Не используйте strong consistency там, где достаточно eventual или weak.

